---
title: "Rangewide Analysis"
author: "Andres N. Rosales"
date: "2025-01-24"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

# Candidate Models
**Prediction 1**

Breeding regions declining in trend will be correlated with low landscape heterogeneity and simplified agricultural landscapes.

$Trend = Δ SHDI + Δ Edge Density + Δ Cropland + (1 | Location)$


**Prediction 2**

Greater landscape heterogeneity will lower the negative effects of landscape simplification on breeding trends.
“Is the effect of landscape diversity on Upland Sandpiper population dynamics dependent on the degree of simplification?” 

$Trend = Δ SHDI + Δ Cropland + Δ SHDI * Δ Cropland + (1 | Location)$

**Prediction 3**

Forage agriculture and grasslands are associated with positive trends and high abundance. 
“How are trends in forage agriculture and grasslands associated with trends and abundance of Upland Sandpiper?”

$Trend = Δ Forage Ag + Δ Grassland + (1 | Location)$

“Does configuration of forage and grassland habitats influence their association with trends and abundance

$Trend = Δ Forage Agriculture * Δ Forage Ag LPI + Δ Grassland *	 Δ Grassland LPI + (1 | Location)$

**Prediction 4**

Trends decline or become more variable with increasing distance from the core breeding range. Conversely, trends will be more stable near the core breeding region. 

$Trend = Periphery + (1 | Location)$


**Prediction 5**

Geographical variation in abundance is driven by marginal habitat at the periphery.

$Trend = Periphery + Δ SHDI +  Δ Cropland + (1 | Location) + (1| Year)$


```{r, message=FALSE, warning=FALSE, include=FALSE}

library(dplyr)
library(purrr)
library(ggplot2)
library(rnaturalearth)
library(sf)
library(raster)
library(terra)
library(tinytex)
library(rmarkdown)
library(knitr)
library(ebirdst)
library(exactextractr)
library(landscapemetrics)
library(readr)
library(stringr)
library(tidyr)
library(units)
library(viridis)
library(progress)
library(dplyr)
library(lme4)
library(mgcv)
library(GGally)
library(car)

```




```{r, include=FALSE}
#Edited trend df
NA_model <- readRDS("Data/NA_model.rds")
names(NA_model)
```



# Response Distribution


Distribution of trend response variable.
```{r}
ggplot(NA_model, aes(x = abd_trend)) +
  geom_histogram(bins = 30, fill = "blue", color = "black") +
  theme_minimal()

```




```{r}
#Distribution of abundance response variable. 
ggplot(NA_model, aes(x = abd)) +
  geom_histogram(bins = 30, fill = "blue", color = "black") +
  theme_minimal()

```

Distribution of abundance estimates. 

# Predictor relationships

Correlation matrix before aggregating predictors.
```{r}
library(ggcorrplot)
# List of predictors to include
predictors <- c(
    "shdi_mean" , "simp_mean" , "FLPI_mean" , "GLPI_mean" , "ED_mean" , "FO_mean" , "GR_mean" 
)

filtered_data <- NA_model %>%
  dplyr::select(all_of(predictors))

cor_matrix <- cor(filtered_data, use = "complete.obs", method = "pearson")

ggcorrplot(cor_matrix, lab = TRUE, lab_size = 3, colors = c("red", "white", "blue"))
```

I still need to determine a pearsons correlation coefficient threshold to report. Some literature has used 0.7 and I will go with that for now. I still need to develop a better backing for this and if this is something I will continue to use going forward...

```{r, message=FALSE}

# Create the ggpairs plot
ggpairs(
  filtered_data,
  lower = list(continuous = wrap("smooth", colour = "blue", size = 1)),
  diag = list(continuous = "densityDiag"), # Add density plots to diagonals
  upper = list(continuous = "cor") # Add correlation values in the upper triangle
)
```

## Shannon Diversity Index


```{r}
ggplot(NA_model, aes(x = shdi_mean, y = abd_trend)) +
  geom_point( alpha = 0.3, size = 2) +  
  geom_smooth(method = "loess",  se = TRUE, linetype = "dashed") + 
  labs(
    title = "Relationship Between SHDI Slope and Trend",
    x = "Slope of SHDI (Change over Time)",
    y = "Trend"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

```


## Landscape Simplification

plot simplification slope against trend
```{r}
ggplot(NA_model, aes(x = simp_mean, y = abd_trend)) +
  geom_point( alpha = 0.3, size = 2) +  
  geom_smooth(method = "loess",  se = TRUE, linetype = "dashed") + 
  labs(
    title = "Relationship Between Simplification Slope and Trend",
    x = "Slope of Simplification (Change over Time)",
    y = "Trend"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )
```


## LPI Grassland

Plot trend ~ slope and trend ~ Mean
```{r}
ggplot(NA_model, aes(x = GLPI_mean, y = abd_trend)) +
  geom_point( alpha = 0.3, size = 2) +  
  geom_smooth(method = "loess", se = TRUE, linetype = "dashed") + 
  labs(
    title = "Relationship Between Grassland LPI and Trend",
    x = "Mean Grassland LPI",
    y = "Trend"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

```

## LPI Forage


Plot trend ~ slope and trend ~ Mean
```{r}
ggplot(NA_model, aes(x = FLPI_mean, y = abd_trend)) +
  geom_point( alpha = 0.3, size = 2) +  
  geom_smooth(method = "loess",  se = TRUE, linetype = "dashed") + 
  labs(
    title = "Relationship Between Forage LPI and Trend",
    x = "Mean forage LPI",
    y = "Trend"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

```

## Edge Density
calculate the slope and average LPI for each location
```{r}
ggplot(NA_model, aes(x = ED_mean, y = abd_trend)) +
  geom_point( alpha = 0.3, size = 2) +  
  geom_smooth(method = "loess",  se = TRUE, linetype = "dashed") + 
  labs(
    title = "Relationship Between Edge Density and Trend",
    x = "Mean Edge Density",
    y = "Abundance Trend (abd_trend)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )
```


# Model Runs


## Null model
```{r}
gam_null <- gam(abd_trend ~ 1, data = NA_model)
glm_null <- glm(abd_trend~1, data = NA_model)
```


## Global Models


Removed both LPI metrics for now due to high correlation with many variables.


### Linear Model
LM 1
```{r}
lm_global <- lm(abd_trend ~ FO_mean + GR_mean +  shdi_mean  + simp_mean + simp_mean*shdi_mean + srd_id, data = NA_model)
summary(lm_global)
plot(lm_global)
vif(lm_global)

```


LM2
```{r}
lm_global2 <- lm(abd_trend ~  GR_mean +  shdi_mean  + simp_mean + srd_id, data = NA_model)
summary(lm_global2)
plot(lm_global2)
vif(lm_global2)

```


### General Linear Model
glm 1
```{r}
glm_global <- glm(abd_trend ~ FO_mean + GR_mean + ED_mean +  shdi_mean + simp_mean + abd + simp_mean*shdi_mean, family = "gaussian", data = NA_model)
summary(glm_global)
plot(glm_global)
vif(glm_global)

```


GLM 2 
GLM global model removing non-informative parameters from glm 1 (mean simp and abd)
```{r}
glm_global2 <- glm(abd_trend ~ FO_mean + GR_mean + ED_mean +  shdi_mean + simp_mean*shdi_mean, family = "gaussian", data = NA_model)
summary(glm_global2)
plot(glm_global2)
vif(glm_global)


```


### GLM Polynomial
GLM with squared polynomial
```{r}
square_global <- lm(
  abd_trend ~ 
    FO_mean + I(FO_mean^2) +
    GR_mean + I(GR_mean^2) +
    ED_mean + I(ED_mean^2) +
    shdi_mean + I(shdi_mean^2) + 
    simp_mean + I(simp_mean^2) + 
    abd + I(abd^2) + 
    I(simp_mean^2)*I(shdi_mean^2) + 
    srd_id,
  data = NA_model
)

# Summary of the model
summary(square_global)
plot(square_global)
```


Squared polynomial model 2
Remove FO mean and non-linear term for simp mean
```{r}
square_global2 <- lm(
  abd_trend ~ 
    GR_mean + I(GR_mean^2) +
    ED_mean + I(ED_mean^2) +
    shdi_mean + I(shdi_mean^2) + 
    simp_mean + 
    I(simp_mean^2)*I(shdi_mean^2) + 
    abd + I(abd^2) +
    srd_id,
  data = NA_model
)

# Summary of the model
summary(square_global2)
plot(square_global2)
```



GLM with cubed polynomial
```{r}
cube_global <- lm(
  abd_trend ~ 
   FO_mean + I(FO_mean^3) +
    GR_mean + I(GR_mean^3) +
    ED_mean + I(ED_mean^3) +
    shdi_mean + I(shdi_mean^3) + 
    simp_mean + I(simp_mean^3) + 
    I(simp_mean^3)*I(shdi_mean^3) + 
    abd + I(abd^3) +
    srd_id,
  data = NA_model
)

# Summary of the model
summary(cube_global)
plot(cube_global)
```


Cube polynomial model 2
```{r}
cube_global2 <- lm(
  abd_trend ~ 
   FO_mean  +
    GR_mean + I(GR_mean^3) +
    shdi_mean + I(shdi_mean^3) + 
    simp_mean + I(simp_mean^3) + 
    I(simp_mean^3)*I(shdi_mean^3) + 
    abd + I(abd^3) +
    srd_id,
  data = NA_model
)

# Summary of the model
summary(cube_global2)
plot(cube_global2)
```



GLM with quadratic polynomial
```{r}
quadratic_global <- lm(
  abd_trend ~ 
    FO_mean + I(FO_mean^4) +
    GR_mean + I(GR_mean^4) +
    ED_mean + I(ED_mean^4) +
    shdi_mean + I(shdi_mean^4) + 
    simp_mean + I(simp_mean^4) + 
    I(simp_mean^4)*I(shdi_mean^4) + 
    abd + I(abd^4) +
    srd_id,
  data = NA_model
)

# Summary of the model
summary(quadratic_global)
plot(quadratic_global)
```


```{r}
quadratic_global2 <- lm(
  abd_trend ~ 
    FO_mean + 
    GR_mean + I(GR_mean^4) +
    shdi_mean + I(shdi_mean^4) + 
    simp_mean + I(simp_mean^4) + 
    I(simp_mean^4)*I(shdi_mean^4) +
    abd + I(abd^4) +
    srd_id,
  data = NA_model
)

# Summary of the model
summary(quadratic_global2)
plot(quadratic_global2)
```


### General Additive Models
GAM 1
```{r}
gam_global <- gam(abd_trend ~ s(FO_mean) + s(GR_mean) + s(ED_mean) +  s(shdi_mean) + s(simp_mean) + s(abd) +  s(shdi_mean, simp_mean) + s(longitude, latitude), data = NA_model, method = "REML")
summary(gam_global)
plot(gam_global)
gam.check(gam_global)

```


GAM 2
Based on the EDF in the gam_global model, I will change terms with EDF near 1 to linear terms and drop non-informative parameters
```{r}
gam_global2 <- gam(abd_trend ~ s(FO_mean) + s(GR_mean) + s(ED_mean) +  s(shdi_mean) + simp_mean + s(abd) +  s(shdi_mean, simp_mean) + s(longitude, latitude), data = NA_model, method = "REML")
summary(gam_global2)
gam.check(gam_global2)

```


### Global models AIC
```{r}
globals <- AIC(gam_null, lm_global, lm_global2, glm_global, glm_global2, square_global, square_global2, cube_global, cube_global2, quadratic_global, quadratic_global2, gam_global, gam_global2)

globals
```




### Prediction 1

```{r}
P1gam <- gam(abd_trend ~ s(mean_shdi) + s(mean_simp) + s(longitude, latitude), data = upsa_trd)
summary(P1gam)
plot(P1gam)
gam.check(P1gam)
```

glm
```{r}
P1glm <- glm(abd_trend ~ mean_shdi + mean_simp + srd_id, data = upsa_trd)
P1glm2 <- glm(abd_trend ~ mean_shdi + mean_simp, data = upsa_trd)

summary(P1glm)
plot(P1glm)
```

```{r}
AIC(P1gam, P1glm, P1glm2, gam_null)
```

