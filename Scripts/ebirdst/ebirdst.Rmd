---
title: "eBirdst Script for Chapter 1"
author: "Andres N. Rosales"
date: "2024-09-04"
output: 
  html_document: 
    highlight: espresso
    toc: yes
    theme: sandstone
---

# Analyzing Landscape-Level Factors Influencing Upland Sandpiper Population Dynamics

This code extracts and manipulates eBird status and trends data for the first chapter of my thesis. More infomation and visualizations can be found at <https://science.ebird.org/en/status-and-trends/species/uplsan/trends-map>

## Library

```{r}


library(dplyr)
library(ggplot2)
library(rnaturalearth)
library(sf)
library(terra)
library(ebirdst)


```





## Extract
This code views and extracts available status and trend data for Upland Sandpiper.


Set unique key to access eBirdst data (expires Jan 18th 2025)
```{r}
set_ebirdst_access_key("3t1ddtda3uh3", overwrite = TRUE)

```

shows all species with status and trend data available. We will subset to show Upland Sandpiper data availability. 
```{r}

trends_runs <- ebirdst_runs %>% 
  filter(has_trends) %>% 
  select(species_code, common_name,
         trends_season, trends_region,
         trends_start_year, trends_end_year,
         trends_start_date, trends_end_date,
         rsquared, beta0)

upsa <- trends_runs %>% 
  filter(common_name == "Upland Sandpiper") %>% 
  select(trends_start_year, trends_end_year, 
         trends_start_date, trends_end_date)

upsa

```
### Rasterize Upland Sandpiper trends
Create object with trends
```{r}
uppies_trends <- load_trends("uplsan")

(uppies_trends)

write.csv(uppies_trends, file = "C:/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/eBird trend data/Cornell/Clean/uppies_trends20122022.csv", row.names = FALSE) 
```


rasterize cumulative trend estimate using `terra` package
```{r}
trends_raster <- rasterize_trends(uppies_trends, 
                                  layers = c("abd"))

#uses sinusodial projection, may need to create custom CRS definition when bringing into arcpro
print(trends_raster)


```


Define projection as Alberts Conic Equal Area (EPSG 5070) and save as Geotiff
```{r}


#keep projection and change in arcpro
#save as a geotiff for use in arcpro
writeRaster(trends_raster, filename = "C:/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/Shapefiles/ebirdst/Uppies_abd_rasterized2022.tif", overwrite = TRUE)

plot(trends_raster)

```

### Vector of pixel locations
load vector of the pixel points 

```{r}
trends_pixel <- st_as_sf(uppies_trends,
                         coords = c("longitude", "latitude"),
                                    crs = 4326)
# uses WGS 84 coordinate system (EPSG 4326)
print(trends_pixel)
```

Export shapefile to path 
```{r}
write_sf(trends_pixel,"C:/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/Shapefiles/ebirdst/pixel_vector20122022.gpkg",
         layer = "uppies_trends")

plot(trends_pixel)
```



### Strimas-Mackey Upland Sandpiper data (2007-2021) 

Read in CSV and manipulate to subset trends with >80% confidence
```{r}

long_trend <- read.csv("/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/eBird trend data/prairie analysis/PHJV_trends.csv")
str(long_trend)

#create col for confidence interval non zero, 1 is True, 0 is False
long_trend$abd_ppy_nonzero <- NA
long_trend$abd_ppy_nonzero <- as.factor(long_trend$abd_ppy_nonzero)

#ifelse statement to label that pixel if overlapping zero
long_trend$abd_ppy_nonzero <- ifelse(long_trend$abd_ppy_lower > 0 | long_trend$abd_ppy_upper < 0, 1, 0)

#subset only significant trends with high confidence
sig_trends <- subset(long_trend, abd_ppy_nonzero == "1")

#apply compund interest to trend to get cumulative trend 
#abd_trend: the median estimated cumulative change in relative abundance over the trend time period
#equation:abd_trend <- 100 * ((1 + abd_ppy / 100)^(2021 - 2007) - 1)

sig_trends$abd_trend <- NA
sig_trends$abd_trend <- 100 * ((1 + sig_trends$abd_ppy / 100)^(2021 - 2007) - 1)

glimpse(sig_trends)

```


Save as a CSV to path
```{r}

write.csv(sig_trends, file = "C:/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/eBird trend data/Cornell/Clean/sig_trends20072021.csv", row.names = FALSE)


```



















## Session Info
```{r}
sessionInfo()
```

