---
title: "eBirdst Script for Chapter 1"
author: "Andres N. Rosales"
date: "2024-10-10"
output:
  pdf_document:
    toc: yes
  word_document:
    toc: yes
  html_document:
    highlight: espresso
    toc: yes
    theme: sandstone
---

# Analyzing Landscape-Level Factors Influencing Upland Sandpiper Population Dynamics

This code extracts and manipulates eBird status and trends data for the first chapter of my thesis. More infomation and visualizations can be found at <https://science.ebird.org/en/status-and-trends/species/uplsan/trends-map>

## Library

```{r, message=FALSE, warning=FALSE}


library(dplyr)
library(purrr)
library(ggplot2)
library(rnaturalearth)
library(sf)
library(raster)
library(terra)
library(ebirdst)


```





## Extract Status and Trend Data
This code views and extracts available status and trend data for Upland Sandpiper.


Set unique key to access eBirdst data (expires Jan 18th 2025)
```{r}
set_ebirdst_access_key("3t1ddtda3uh3", overwrite = TRUE)

```

Show all species with status and trend data available. We will subset to show Upland Sandpiper data availability. 
```{r}

trends_runs <- ebirdst_runs %>%
  filter(has_trends) %>%
  dplyr::select(
    species_code, common_name, trends_season, trends_region,
    trends_start_year, trends_end_year, trends_start_date,
    trends_end_date, rsquared, beta0
  )

upsa <- trends_runs %>%
  filter(common_name == "Upland Sandpiper") %>%
  dplyr::select(trends_start_year, trends_end_year, 
                trends_start_date, trends_end_date)

upsa

```
Create an object of Upland Sandpiper trends (2012-2022). 
*waiting for new eBird data release in November
```{r}
uppies_trends <- load_trends("uplsan")

(uppies_trends)

write.csv(uppies_trends, file = "C:/Users/ROSALESA/OneDrive - University of Saskatchewan/17_Analysis/Chapter1/eBird trend data/Cornell/Clean/uppies_trends20122022.csv", row.names = FALSE) 
```

## Calculate Abundance for each year (2012-2022)

Use the equation 

$Ay = A2017 Ã— (1 + r)^{y-2017}$

- Ay is the abundance in year y.
- A2017  is the abundance in 2017 (median year).
- r is the annual percent change expressed as a decimal.
- y is the year of interest.

```{r}

uppies_trends <- uppies_trends %>%
  bind_cols(map_dfc(2012:2022, 
                    ~ tibble(!!paste0("abd_", .x) := uppies_trends$abd * 
                               (1 + uppies_trends$abd_ppy) ^ (.x - 2017))))




```


## Rasterize Upland Sandpiper trends

rasterize cumulative trend estimate using `terra` package
```{r, include=FALSE}
trends_raster <- rasterize_trends(uppies_trends, 
                                  layers = "abd_trend")

#uses sinusodial projection, may need to create custom CRS definition when bringing into arcpro
print(trends_raster)


```


```{r}
#keep projection and change in arcpro
#save as a geotiff for use in arcpro
writeRaster(trends_raster, filename = "C:/Users/ROSALESA/OneDrive - University of Saskatchewan/14_Arcpro/Chapter1/Shapefiles/ebirdst/Uppies_trends_rasterized2022.tif", overwrite = TRUE)

plot(trends_raster)

```


## Vector of Spatial Trends and Abundance
load vector of the pixel points 

```{r}
trends_pixel <- st_as_sf(uppies_trends,
                         coords = c("longitude", "latitude"),
                                    crs = 4326)
# uses WGS 84 coordinate system (EPSG 4326)
print(trends_pixel)
```


Export shapefile to path 
```{r}
write_sf(trends_pixel,"C:/Users/ROSALESA/OneDrive - University of Saskatchewan/14_Arcpro/Chapter1/Shapefiles/ebirdst/pixel_vector20122022.gpkg",
         layer = "uppies_trends")
#plot the vector of trend locations using the srd_id (unique code for every pixel)
plot(trends_pixel["srd_id"])
```


## Session Info
```{r}
sessionInfo()
```

