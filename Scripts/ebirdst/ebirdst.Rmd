---
title: "eBirdst Script for Chapter 1"
author: "Andres N. Rosales"
date: "2024-10-10"
output:
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  html_document:
    highlight: espresso
    toc: yes
    theme: sandstone
---

# Analyzing Landscape-Level Factors Influencing Upland Sandpiper Population Dynamics

This code extracts and manipulates eBird status and trends data for the first chapter of my thesis. More infomation and visualizations can be found at <https://science.ebird.org/en/status-and-trends/species/uplsan/trends-map>

```{r}
#set wd to github folder
setwd("C:/Users/ROSALESA/Desktop/Analysis/UPSA_agri/Scripts/ebirdst")

```


## Library

```{r, message=FALSE, warning=FALSE}


library(dplyr)
library(purrr)
library(ggplot2)
library(rnaturalearth)
library(sf)
library(raster)
library(terra)
library(tinytex)
library(rmarkdown)
library(knitr)
library(ebirdst)


```


## Extract Status and Trend Data
This code views and extracts available status and trend data for Upland Sandpiper.


Set unique key to access eBirdst data (expires Jan 18th 2025)
```{r}
set_ebirdst_access_key("3t1ddtda3uh3", overwrite = TRUE)

```

Show all species with status and trend data available. We will subset to show Upland Sandpiper data availability. 
```{r}

trend_runs <- ebirdst_runs %>%
  filter(has_trends) %>%
  dplyr::select(
    species_code, common_name, trends_season, trends_region,
    trends_start_year, trends_end_year, trends_start_date,
    trends_end_date, rsquared, beta0
  )

u_runs <- trend_runs %>%
  filter(common_name == "Upland Sandpiper") %>%
  dplyr::select(trends_start_year, trends_end_year, 
                trends_start_date, trends_end_date)
```




Create an object of Upland Sandpiper trends (2012-2022). 
*waiting for new eBird data release in November
```{r}
ebirdst_download_trends("Upland Sandpiper")

utrends_st <- load_trends("Upland Sandpiper")


# Write a csv of each trend pixel 
write.csv(utrends_st, file = "C:/Users/Andres/OneDrive - University of Saskatchewan/02_Analysis/Chapter1/eBird trend data/Cornell/eBirdst package/2012-2022/Raw/utrends20122022.csv", row.names = FALSE) 
# Write a csv of each trend pixel 
write.csv(utrends_st, file = "Data/utrends20122022.csv", row.names = FALSE) 
```


## Vector of Spatial Trends and Abundance
load vector of the pixel points 

```{r}
utrends_sf <- st_as_sf(utrends_st, 
                       coords = c("longitude", "latitude"), 
                       crs = st_crs(4326))
#Save as a GeoPackage to working directory
write_sf(utrends_sf,"Trends_sf/utrends_sf2022.gpkg", layer = "uppies_trends")
```

check for the centroid of the study region
```{r}
utrends_sf |> 
  st_union() |> 
  st_centroid() |> 
  st_coordinates() |> 
  round(1)

```


#Spatial Buffer for predictor grid

Using utrend_st make an 'sf' object. Set crs as WGS84 then reproject to NAD83 (5070)
```{r}
#I need to make a custom CRS string for EPSP 102008 to use in place of 5070

utrends_buff <- utrends_st |> 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>  
  st_transform(crs = 5070) |>                                   # Transform to NAD 83 (EPSG 5070)
  st_buffer(dist = 13500)                                        # Create 13.5 km buffers

ggplot() +
  geom_sf(data = utrends_buff, fill = "lightblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() +
  labs(title = "13.5 km Circular Buffers", x = "Longitude", y = "Latitude")


write_sf(utrends_buff,"C:/Users/Andres/OneDrive - University of Saskatchewan/03_Arcpro/Chapter1/Shapefiles/ebirdst/Buffer/utrends_buff.gpkg",
         layer = "ubuff")

overlap <- st_intersection(utrends_buff)
write_sf(utrends_buff,"Predictor_buffer/utrends_buff.gpkg", overwrite = TRUE)

```




## Rasterize Upland Sandpiper trends

rasterize cumulative trend estimate using `terra` package
```{r, include=FALSE}
utrends_ras <- rasterize_trends(utrends_st, 
                                  layers = c("abd_trend"))


```


```{r}
#save as a geotiff for use in arcpro
writeRaster(utrends_ras, filename = "Rasters/utrends_ras2022.tif", overwrite = TRUE)

plot(utrends_ras)

```



#Status Predictive Importance
Downloads and views the eBird status data for Upland Sandpiper (along with PI for variables).
Only top 30 ranked PI are given in the object 'pi' These are downloaded to the eBird Directory, not in working directory
```{r}
ebirdst_download_status("uplsan", download_pis = TRUE)

upsa_pi <- list_available_pis("uplsan")
print(pi)

pi <- ebirdst_predictors
pi_des <- ebirdst_predictor_descriptions

```


## Rasterize Upland Sandpiper trends

rasterize cumulative trend estimate using `terra` package
```{r, include=FALSE}
utrends_ras <- rasterize_trends(utrends_st, 
                                  layers = c("abd_trend"))


```


```{r}
#keep projection and change in arcpro
#save as a geotiff for use in arcpro
writeRaster(utrends_ras, filename = "C:/Users/Andres/OneDrive - University of Saskatchewan/14_Arcpro/Chapter1/Shapefiles/ebirdst/utrends_ras2022.tif", overwrite = TRUE)

plot(utrends_ras)

```





## Session Info
```{r}
sessionInfo()
```

